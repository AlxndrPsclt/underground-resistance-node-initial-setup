---
- hosts: rpis
  tasks:
  #    - name: test connection
  #      ping:
  #
##################
#Users and groups#
##################
    - name: Ensure groups ansible and docker exist
      become: yes
      group:
        name: "{{ item }}"
        state: present
      with_items:
        - ansible
        - docker
  
    - name: Load passwords from vault
      #Passwords must be stored in a file located in vars/user_passwords.yml. This file contains entries for each account to create, associated to passwords hased with sha512
      #These can be generated using:
      #mkpasswd --method=sha-512
      #Resulting line should look like this:
      #username: '$6$LLzRkpZJM1b$CvFO*******************************************************************9uYUB0gHHgZQfc/'
      include_vars:
        file: user_passwords.yml
        name: user_passwords

#    - debug:
#        var: user_passwords

    - name: Create users
      become: yes
      user:
        name: "{{item.key}}"
        password: "{{item.value}}"
        groups: ansible, docker, sudo   # Empty by default.
      with_dict: "{{ user_passwords }}"
        #state: present
        #shell: /bin/bash       # Defaults to /bin/bash
        #system: no             # Defaults to no
        #createhome: yes        # Defaults to yes
        #home: /home/alex  # Defaults to /home/<username>



#####################
#Installing software#
#####################
    - name: Update repositories cache and install usefull packages
      become: yes
      apt:
        name: "{{ item }}"
        update_cache: yes
        cache_valid_time: 3600
      with_items:
        - git
        - vim-nox
#        - python3-pip

    - name: Remove dependencies that are no longer required
      become: yes
      apt:
        autoremove: yes


################################
#Creating directories structure#
################################
    - name: ansible create multiple directory example
      become: yes
      file:
        path: "{{ item.dest }}"
        group: "{{ item.group }}"
        mode: "{{ item.mode }}"
        state: directory
      with_items:
        - { dest: '/docker', group: 'root', mode: '0755' }
        - { dest: '/docker/src', group: 'docker', mode: '0775' }
        - { dest: '/docker/volumes', group: 'docker', mode: '0775' }
        - { dest: '/docker/configs', group: 'docker', mode: '0775' }
        - { dest: '/ansible', group: 'ansible', mode: '0775' }
